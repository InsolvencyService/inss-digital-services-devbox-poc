$schema: "1.0"
name: "platform-developer-with-sql-image-definition-yaml"
image: AdditionalImages/VS2006-Image-Definition@1.0.0

tasks:
  - name: winget
    description: "Install Microsoft SQL Server Management Studio 21"
    parameters:
      package: Microsoft.SQLServerManagementStudio.21

  - name: winget
    description: "Install NodeJS"
    parameters:
      package: OpenJS.NodeJS

  - name: winget
    description: "Install Chrome"
    parameters:
      package: Google.Chrome

  - name: winget
    description: "Install Notepad++"
    parameters:
      package: Notepad++.Notepad++

  - name: git-clone
    description: "Clone INSS Digital Platform to c:\\repos"
    parameters:
      repositoryUrl: https://github.com/InsolvencyService/inss-digital-services-platform.git
      directory: c:\repos

  - name: git-clone
    description: "Clone INSS Digital Platform POC to c:\\repos"
    parameters:
      repositoryUrl: https://github.com/InsolvencyService/inss-digital-platform-poc.git
      directory: c:\repos

  - name: git-clone
    description: "Clone INSS Digital Platform Prototypes to C:\\Prototypes"
    parameters:
      repositoryUrl: https://github.com/InsolvencyService/inss-digital-services-prototypes.git
      directory: C:\Prototypes
      
userTasks:
  - name: winget
    description: "Install Postman"
    parameters:
      package: Postman.Postman

  - name: powershell
    description: "Install SQL Server 2022 Developer silently"
    parameters:
      command: |
        $ErrorActionPreference = 'Stop'

        # Paths
        $dlRoot   = 'C:\SQLDl'
        $mediaDir = 'C:\SQL2022\Media'

        New-Item -ItemType Directory -Force -Path $dlRoot, $mediaDir | Out-Null

        # 1) Download the SQL bootstrapper via winget
        winget download Microsoft.SQLServer.2022.Developer `
          --accept-package-agreements `
          --accept-source-agreements `
          --download-directory $dlRoot

        # Locate the downloaded bootstrapper
        $bootstrap = Get-ChildItem $dlRoot -Filter *.exe | Select-Object -First 1
        if (-not $bootstrap) { throw "SQL bootstrapper not found in $dlRoot" }

        # 2) Use bootstrapper to download full SQL media
        $downloadArgs = "/ACTION=Download /MEDIATYPE=CAB /MEDIAPATH=$mediaDir /QUIET"
        Start-Process -FilePath $bootstrap.FullName -ArgumentList $downloadArgs -Wait -NoNewWindow

        # Locate setup.exe inside media folder
        $setup = Get-ChildItem $mediaDir -Recurse -Filter setup.exe | Select-Object -First 1
        if (-not $setup) { throw "SQL setup.exe not found under $mediaDir" }

        # 3) Install SQL Server silently
        $installArgs = "/Q /ACTION=Install /FEATURES=SQLENGINE /INSTANCENAME=MSSQLSERVER /SQLSYSADMINACCOUNTS=""Administrators"" /IACCEPTSQLSERVERLICENSETERMS=TRUE"
        Start-Process -FilePath $setup.FullName -ArgumentList $installArgs -Wait -NoNewWindow

        # 4) Basic verification
        Start-Sleep -Seconds 5
        sc.exe query MSSQLSERVER | Out-String | Write-Host

        