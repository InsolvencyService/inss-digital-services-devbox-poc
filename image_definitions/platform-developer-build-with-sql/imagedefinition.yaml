$schema: "1.0"
name: "platform-developer-with-sql-image-definition-yaml"
image: AdditionalImages/VS2006-Image-Definition@1.0.0

tasks:
  - name: winget
    description: "Install Microsoft SQL Server Management Studio 21"
    parameters:
      package: Microsoft.SQLServerManagementStudio.21

  - name: winget
    description: "Install NodeJS"
    parameters:
      package: OpenJS.NodeJS

  - name: winget
    description: "Install Chrome"
    parameters:
      package: Google.Chrome

  - name: winget
    description: "Install Notepad++"
    parameters:
      package: Notepad++.Notepad++

  - name: git-clone
    description: "Clone INSS Digital Platform to c:\\repos"
    parameters:
      repositoryUrl: https://github.com/InsolvencyService/inss-digital-services-platform.git
      directory: c:\repos

  - name: git-clone
    description: "Clone INSS Digital Platform POC to c:\\repos"
    parameters:
      repositoryUrl: https://github.com/InsolvencyService/inss-digital-platform-poc.git
      directory: c:\repos

  - name: git-clone
    description: "Clone INSS Digital Platform Prototypes to C:\\Prototypes"
    parameters:
      repositoryUrl: https://github.com/InsolvencyService/inss-digital-services-prototypes.git
      directory: C:\Prototypes
      
userTasks:
  - name: winget
    description: "Install Postman"
    parameters:
      package: Postman.Postman

  - name: powershell
    description: "Install SQL Server 2022 Developer silently"
    parameters:
      command: |
        $ErrorActionPreference = 'Stop'

        $dlRoot   = 'C:\SQLDl'
        $mediaDir = 'C:\SQL2022\Media'
        New-Item -ItemType Directory -Force -Path $dlRoot, $mediaDir | Out-Null

        # 1) Download the web bootstrapper via winget
        winget download Microsoft.SQLServer.2022.Developer `
          --accept-package-agreements --accept-source-agreements `
          --download-directory $dlRoot

        # Find the downloaded bootstrapper (*.exe) - not setup.exe yet
        $bootstrap = Get-ChildItem $dlRoot -Filter *.exe | Select-Object -First 1
        if (-not $bootstrap) { throw "SQL bootstrapper not found in $dlRoot" }

        # 2) Use bootstrapper to download full media (CAB set) silently
        #    Options: /MEDIATYPE=CAB or ISO. CAB avoids mounting.
        Start-Process -FilePath $bootstrap.FullName -ArgumentList @(
          '/ACTION=Download',
          "/MEDIATYPE=CAB",
          "/MEDIAPATH=$mediaDir",
          '/QUIET'
        ) -Wait -NoNewWindow

        # Verify setup.exe exists in media folder (e.g., C:\SQL2022\Media\Developer_ENU\setup.exe)
        $setup = Get-ChildItem $mediaDir -Recurse -Filter setup.exe | Select-Object -First 1
        if (-not $setup) { throw "SQL setup.exe not found under $mediaDir" }

        # 3) Run setup.exe silently (core engine only; add features as needed)
        $args = @(
          '/Q',
          '/ACTION=Install',
          '/FEATURES=SQLENGINE',
          '/INSTANCENAME=MSSQLSERVER',
          '/SQLSYSADMINACCOUNTS="Administrators"',
          '/IACCEPTSQLSERVERLICENSETERMS=TRUE'
        )
        Start-Process -FilePath $setup.FullName -ArgumentList $args -Wait -NoNewWindow

        # Optional: basic service check
        Start-Sleep -Seconds 5
        sc.exe query MSSQLSERVER | Out-String | Write-Host
    
